<?php
//---------------------------
//Archivo mdl/IndexMdl.sia.php
//---------------------------

class IndexMdl extends ModeloBase
{
//-----------------------------------------------------------
//--------------------- CONSULTAS DE LOGIN 
//-----------------------------------------------------------
    // --> Verifica si el estudiante es en la BD
    public function VerificarLogin ($usuario, $clave)
    {	//realizamos la consulta del estudiante
        $sql = "SELECT *, CONCAT_WS(' ',Paterno, Materno, Nombres) AS usuario FROM docente
                        WHERE (Paterno = '$usuario' OR (Paterno='' AND Materno = '$usuario')) AND Clave = '$clave'";
        return ($this->EjecutarConsulta($sql));
    }

     // --> Verifica la clave de docente
    public function Mdl_VerificarClave ($CodDocente, $clave)
    {	
        $sql = "SELECT * FROM docente WHERE CodDocente='$CodDocente' AND Clave = '$clave'";
        return ($this->EjecutarConsulta($sql));
    }

      // --> Verifica la clave de docente
    public function Mdl_ModificarClave ($CodDocente, $NuevaClave)
    {	
        $sql="UPDATE docente SET Clave='$NuevaClave' WHERE CodDocente='$CodDocente'";

       $this->EjecutarABC($sql);    //ejecuta la Inserts Update y Deletes;
    }

     // --> Verifica el rotulo de una materia
    public function Mdl_VerificarRotulo ($CodMateria)
    {
        $sql = "SELECT * FROM rotulo WHERE CodMateria='$CodMateria'";
        return ($this->EjecutarConsulta($sql));
    }
//---------------------------------------------------------------------------------
//--------------------- CONSULTAS DE REGISTRO NOTAS
//----------------------------------------------------------------------------------
     // --> Retorna las materias que tiene asignado un profesor
    public function Mdl_MateriasProfesores ($CodDocente)
    {   $sql = "SELECT  materia.CodMateria, activacion.FechaInicio, activacion.FechaFin, curso.CodCurso,
                activacion.Evaluacion, activacion.Terminada, activacion.CodAsignacion, A.CodParalelo,
                CONCAT(curso.Nombre, IFNULL((SELECT CONCAT(' ', Nombre, ' ') FROM paralelo WHERE CodParalelo=A.CodParalelo), ''),
                ' - ', materia.Nombre) AS Materia
                FROM docente, asignacion A, materia, curso, area, activacion
                WHERE docente.CodDocente=A.CodDocente
                AND A.CodMateria=materia.CodMateria
                AND materia.CodArea=area.CodArea
                AND curso.CodCurso=area.CodCurso
                And A.CodAsignacion=activacion.CodAsignacion
                AND docente.CodDocente='$CodDocente'";
        return ($this->EjecutarConsulta($sql));
   }

   // --> Retorna las materias
    public function Mdl_MateriasAdmin ()
    {   $sql = "SELECT  materia.CodMateria, activacion.FechaInicio, activacion.FechaFin, curso.CodCurso,
                activacion.Evaluacion, activacion.Terminada, activacion.CodAsignacion, A.CodParalelo,
                CONCAT(curso.Nombre, IFNULL((SELECT CONCAT(' ', Nombre, ' ') FROM paralelo WHERE CodParalelo=A.CodParalelo), ''),
                ' - ', materia.Nombre) AS Materia
                FROM docente, asignacion A, materia, curso, area, activacion
                WHERE docente.CodDocente=A.CodDocente
                AND A.CodMateria=materia.CodMateria
                AND materia.CodArea=area.CodArea
                AND curso.CodCurso=area.CodCurso
                And A.CodAsignacion=activacion.CodAsignacion
                ORDER BY curso.CodCurso, A.CodParalelo, materia.Nombre
                ";
        return ($this->EjecutarConsulta($sql));
   }
      public function Mdl_MateriaNombreProfesor ($CodMateria)
    {	//realizamos la consulta del estudiante
        $sql = "SELECT CONCAT_WS(' ',docente.Paterno, docente.Materno, docente.Nombres) AS usuario FROM docente, asignacion
                        WHERE asignacion.CodMateria='$CodMateria' AND docente.CodDocente=asignacion.CodDocente";
        return ($this->EjecutarConsulta($sql));
    }
   
    // --> Retorna la Materia y sus estudiantes (mas sus notas)
   public function Mdl_MateriaEstudiantes ($CodMateria,$CodParalelo,$CodCurso)
   {   
      //Consulta de la vercion 1
       $sql = " SELECT alu.CodAlumno, nota.CodMateria, n11, d11, n12, d12, n21, d21, n22, d22, n31, d31, n32, d32, rf,
                UPPER(CONCAT(alu.Paterno,' ',alu.Materno,' ',alu.Nombres)) AS estudiante
                FROM alumno AS alu
                LEFT JOIN nota ON (nota.CodAlumno=alu.CodAlumno AND nota.CodMateria='$CodMateria')
                WHERE alu.CodParalelo='$CodParalelo' AND alu.CodCurso='$CodCurso' ";
            
      $Valores=$this->Mdl_Valores('UNIRAPELLIDOS');

      //if($Valores->rowCount()==0)
      if($Valores==0)
           $sql = $sql."ORDER BY alu.Paterno,alu.Materno,alu.Nombres";

      ELSE
           $sql = $sql."ORDER BY concat(alu.Paterno,alu.Materno,alu.Nombres)";
      
      return ($this->EjecutarConsulta($sql));
   }
   public function Mdl_MateriaEstudiantes2 ($CodMateria,$CodParalelo,$CodCurso)
   {
      // consulta Vercion 2
       
      $sql = " SELECT alu.CodAlumno, nota2.CodMateria,
                ud101, ud102, ud103, ud104, ud105, ud106, ud107, ud108, ae101, ae102, ae103, ae104, ae105, ae106, ae107, ae108, ae109, ae110,
                ud201, ud202, ud203, ud204, ud205, ud206, ud207, ud208, ae201, ae202, ae203, ae204, ae205, ae206, ae207, ae208, ae209, ae210, dps201, dps202, dps203,
                ud301, ud302, ud303, ud304, ud305, ud306, ud307, ud308, ae301, ae302, ae303, ae304, ae305, ae306, ae307, ae308, ae309, ae310,
                ud401, ud402, ud403, ud404, ud405, ud406, ud407, ud408, ae401, ae402, ae403, ae404, ae405, ae406, ae407, ae408, ae409, ae410, dps401, dps402, dps403,
                ud501, ud502, ud503, ud504, ud505, ud506, ud507, ud508, ae501, ae502, ae503, ae504, ae505, ae506, ae507, ae508, ae509, ae510,
                ud601, ud602, ud603, ud604, ud605, ud606, ud607, ud608, ae601, ae602, ae603, ae604, ae605, ae606, ae607, ae608, ae609, ae610, dps601, dps602, dps603, rf,
                UPPER(CONCAT(alu.Paterno,' ',alu.Materno,' ',alu.Nombres)) AS estudiante
                FROM alumno AS alu
                LEFT JOIN nota2 ON (nota2.CodAlumno=alu.CodAlumno AND nota2.CodMateria='$CodMateria')
                WHERE alu.CodParalelo='$CodParalelo' AND alu.CodCurso='$CodCurso' ";


      $Valores=$this->Mdl_Valores('UNIRAPELLIDOS');

      //if($Valores->rowCount()==0)
      if($Valores==0)
           $sql = $sql."ORDER BY alu.Paterno,alu.Materno,alu.Nombres";

      ELSE
           $sql = $sql."ORDER BY concat(alu.Paterno,alu.Materno,alu.Nombres)";

      return ($this->EjecutarConsulta($sql));
   }
   //inserta datos en tabla "nota"
   public function Mdl_NotaInsert($CodAlumno,$CodMateria,$values)
   {
       $sqlVerificar="SELECT * FROM nota WHERE $CodAlumno AND $CodMateria";
       $resultado=$this->EjecutarConsulta($sqlVerificar);

        if ($resultado->rowCount()==0)
            $sql="INSERT INTO nota SET $CodAlumno, $CodMateria, $values";
        else
            $sql="UPDATE nota SET $values WHERE $CodAlumno AND $CodMateria";
echo $values;
        $this->EjecutarABC($sql);    //ejecuta la Inserts Update y Deletes;

   }
   //inserta datos en tabla "nota2"
   public function Mdl_Nota2Insert($CodAlumno,$CodMateria,$values)
   {   
       $sqlVerificar="SELECT * FROM nota2 WHERE $CodAlumno AND $CodMateria";
       $resultado=$this->EjecutarConsulta($sqlVerificar);
      
        if ($resultado->rowCount()==0)
            $sql="INSERT INTO nota2 SET $CodAlumno, $CodMateria, $values";
        else
            $sql="UPDATE nota2 SET $values WHERE $CodAlumno AND $CodMateria";

        $this->EjecutarABC($sql);    //ejecuta la Inserts Update y Deletes;

   }

   //inserta datos en tabla "rotulo"
   public function Mdl_RotuloInsert($CodMateria,$values)
   {
       $sqlVerificar="SELECT * FROM rotulo WHERE $CodMateria";
       $resultado=$this->EjecutarConsulta($sqlVerificar);

        if ($resultado->rowCount()==0)
            $sql="INSERT INTO rotulo SET $CodMateria, $values";
        else
            $sql="UPDATE rotulo SET $values WHERE $CodMateria";

        $this->EjecutarABC($sql);    //ejecuta la Inserts Update y Deletes;

   }

   public function Mdl_ActivacionUpdate($CodAsignacion)
   {   $sql="UPDATE activacion SET Terminada=1 WHERE CodAsignacion='$CodAsignacion'";
       $this->EjecutarABC($sql);    //ejecuta la Inserts Update y Deletes;

   }

    //// garmaser --------------
    //ejecuta consultas normales con SELECT
    function EjecutarConsulta($sql)
    {	$consulta = $this->bd->prepare($sql);
            $consulta->execute();
            return $consulta;
    }
    
    //ejecuta consultas de tipo INSERT, UPDATE y DELETE
     function EjecutarABC($sql)
    {	$this->bd->exec($sql);
    }

//---------------------------------------------------------------------------------
//--------------------- CONSULTAS DE PARAMETROS DE TABLA VALORES
//----------------------------------------------------------------------------------

    function Mdl_MAXPCPRIMARIA()
    {   $sql="SELECT Numero FROM valores WHERE Codigo='MAXPCPRIMARIA'";
        $valor=$this->EjecutarConsulta($sql);
        if($valor->rowCount()==0)
            return(0);
         else{
            $valorAux=$valor->fetchAll();      
            return ($valorAux[0]['Numero']);
         }
   }


   function Mdl_MAXPCSECUNDARIA()
    {   $sql="SELECT Numero FROM valores WHERE Codigo='MAXPCSECUNDARIA'";
        $valor=$this->EjecutarConsulta($sql);
        if($valor->rowCount()==0)
            return(0);
         else{
            $valorAux=$valor->fetchAll();
            return ($valorAux[0]['Numero']);
         }
   }
   function Mdl_MINPC()
    {   $sql="SELECT Numero FROM valores WHERE Codigo='MINPC'";
        $valor=$this->EjecutarConsulta($sql);
        if($valor->rowCount()==0)
            return(0);
         else{
            $valorAux=$valor->fetchAll();
            return ($valorAux[0]['Numero']);
         }
   }

   function Mdl_MINDPS()
    {   $sql="SELECT Numero FROM valores WHERE Codigo='MINDPS'";
        $valor=$this->EjecutarConsulta($sql);
        if($valor->rowCount()==0)
            return(0);
         else{
            $valorAux=$valor->fetchAll();
            return ($valorAux[0]['Numero']);
         }
   }

   function Mdl_linea2()
   {   $sql="SELECT Cadena FROM valores WHERE Codigo='LINEA2'";
        $valor=$this->EjecutarConsulta($sql);
        if($valor->rowCount()==0)
            return(0);
         else{
            $valorAux=$valor->fetchAll();
            return ($valorAux[0]['Cadena']);
         }
   }

   function Mdl_linea3()
   {   $sql="SELECT Cadena FROM valores WHERE Codigo='LINEA3'";
        $valor=$this->EjecutarConsulta($sql);
        if($valor->rowCount()==0)
            return(0);
         else{
            $valorAux=$valor->fetchAll();
            return ($valorAux[0]['Cadena']);
         }
   }

    //consulta para verificar valores de la talba VALORES
    function Mdl_Valores($codigo)
    {   $sql="SELECT * FROM valores WHERE Codigo='$codigo'";
        $aux = $this->EjecutarConsulta($sql);
        $aux = $aux->fetchAll();
        return ($aux[0]['Numero']);

    }
}
?>