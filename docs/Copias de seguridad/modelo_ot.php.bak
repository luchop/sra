<?php

class Modelo_ot extends CI_Model {

    private $Tabla = 'ot';
	private $CodInstitucion;
	private $CodUsuario;

    function __construct() {
        parent::__construct();
		$this->CodInstitucion=0;
		$this->CodUsuario=0;
    }

	function SetCodInstitucion($CodInstitucion){
		$this->CodInstitucion=$CodInstitucion;
	}
	
	function SetUsuario($CodUsuario){
		$this->CodUsuario=$CodUsuario;
	}

    function Insert($Numero,$CodCliente, $CodArticulo, $CodMarca, $CodModelo, $Fecha, $CodEstado, $Precio, $Notas) {
        $sql = "INSERT INTO $this->Tabla (Numero, CodCliente, CodArticulo, CodMarca, CodModelo, Fecha, CodEstado, Precio, Obs, CodUsuario, CodInstitucion) 
                VALUES ('$Numero','$CodCliente', '$CodArticulo', '$CodMarca', '$CodModelo', '$Fecha', '$CodEstado', '$Precio', '$Notas', $this->CodUsuario, $this->CodInstitucion)";
        $this->db->query($sql);
        
        $sql = "SELECT LAST_INSERT_ID() AS Codigo";
        $query = $this->db->query($sql);
        if ( $query->num_rows()>0 )
           return $query->row()->Codigo;
        else        
            return 0;
    }

    function Update($CodOT,$Numero,$CodCliente, $CodArticulo, $CodMarca, $CodModelo, $Fecha, $CodEstado, $Precio, $Notas) {
        $sql = "UPDATE $this->Tabla SET Numero='$Numero',CodCliente='$CodCliente', CodArticulo='$CodArticulo', CodMarca='$CodMarca', CodModelo='$CodModelo', Fecha='$Fecha', CodEstado='$CodEstado', Precio='$Precio', Obs='$Notas'
                WHERE CodOT=$CodOT";
        return $this->db->query($sql);
    }

    function Busqueda($CodCliente,$CodEstado,$Numero,$Fecha) {
        $sql = "SELECT ot.*, estado.Nombre AS NombreEstado,
				articulo.Nombre AS NombreArticulo,
				marca.Nombre AS NombreMarca,
				modelo.Nombre AS NombreModelo,
				cliente.Nombre AS NombreCliente
				FROM ot LEFT JOIN estado ON ot.CodEstado=estado.CodEstado
				LEFT JOIN articulo ON ot.CodArticulo=articulo.CodArticulo
				LEFT JOIN marca ON ot.CodMarca=marca.CodMarca
				LEFT JOIN modelo ON ot.CodModelo=modelo.CodModelo
				LEFT JOIN cliente ON ot.CodCliente=cliente.CodCliente
				where 
                (ot.CodCliente='$CodCliente' or '$CodCliente'='') and 
                (ot.CodEstado='$CodEstado' or '$CodEstado'='') and 
                (ot.Numero like '%$Numero%' or '$Numero'='') and 
                (ot.Fecha='$Fecha' or '$Fecha'='')				
                ORDER BY ot.Fecha";
        return $this->db->query($sql);
    }

    function getFila($CodOT) {
        $sql = "select * from $this->Tabla where CodOT=$CodOT";
        return $this->db->query($sql)->row();
    }

    function Delete($CodOT) {
        $this->db->where('CodOT', $CodOT);
        $this->db->delete($this->Tabla);
    }

    function BuscarCliente($Cliente){
        $sql = "SELECT * FROM cliente
                WHERE Nombres LIKE('%$Cliente%')
                OR Apellidos LIKE('%$Cliente%')
                ORDER BY Nombres, Apellidos";
        $resultado=mysql_query($sql,$link); 
        return $resultado;
    }
	
	function GetModeloNombre($CodModelo) {
        $sql = "SELECT Nombre FROM modelo WHERE CodModelo=$CodModelo";
        $query = $this->db->query($sql);
        if( $query->num_rows()>0) {
            $row = $query->row();
            return $row->Nombre;
        }else
            return '';
    }
	
	function GetMarcaNombre($CodMarca) {
        $sql = "SELECT Nombre FROM marca WHERE CodMarca=$CodMarca";
        $query = $this->db->query($sql);
        if( $query->num_rows()>0) {
            $row = $query->row();
            return $row->Nombre;
        }else
            return '';
    }
    
    function ComboMarca($CodMarca,$Requerido=0) {
        $sql = "select * from marca where CodInstitucion=$this->CodInstitucion order by Nombre";
        $resultado = $this->db->query($sql);
		$class_requerido=($Requerido==1) ? 'class="required"' : '';
        $s = "<select name='CodMarca' id='CodMarca' $class_requerido>";
		$s .= "<option value=''>Seleccione una opcion</option>";
        foreach($resultado->result() as $row) 
            $s .= "<option value=".$row->CodMarca.($CodMarca==$row->CodMarca? ' selected ':'').">".$row->Nombre."</option>";
        return $s."</select>";
    }
	
	function ComboModelo($CodModelo,$Requerido=0) {
        $sql = "select * from modelo where CodInstitucion=$this->CodInstitucion order by Nombre";
        $resultado = $this->db->query($sql);
		$class_requerido=($Requerido==1) ? 'class="required"' : '';
        $s = "<select name='CodModelo' id='CodModelo' $class_requerido>";
		$s .= "<option value=''>Seleccione una opcion</option>";
        foreach($resultado->result() as $row)
            $s .= "<option value=".$row->CodModelo.($CodModelo==$row->CodModelo? ' selected ':'').">".$row->Nombre."</option>";
        return $s."</select>";       
    }
	
	function ComboEstado($CodEstado,$Requerido=0) {
        $sql = "select * from estado order by Nombre";
        $resultado = $this->db->query($sql);
		$class_requerido=($Requerido==1) ? 'class="required"' : '';
        $s = "<select name='CodEstado' id='CodEstado' $class_requerido>";
		$s .= "<option value=''>Seleccione una opcion</option>";
        foreach($resultado->result() as $row)
            $s .= "<option value=".$row->CodEstado.($CodEstado==$row->CodEstado ? ' selected ':'').">".$row->Nombre."</option>";
        return $s."</select>";       
    }
	
	function ObtieneNumero() {
        $sql = "SELECT MAX(Numero) AS Mayor FROM $this->Tabla WHERE CodInstitucion=$this->CodInstitucion";
        $query = $this->db->query($sql);
        if( $query->num_rows()>0) {
            $row = $query->row();
            return $row->Mayor;
        }else
            return 0;	
	}
 
}

?>