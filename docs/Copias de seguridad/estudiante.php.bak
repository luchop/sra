<?php

class Estudiante extends CI_Controller {

    function __construct() {
        parent::__construct();
        $this->load->library(array('table', 'form_validation', 'funciones'));
        $this->load->helper(array('url', 'utiles'));
        $this->load->model('modelo_estudiante', '', TRUE);
        $this->load->model('modelo_curso', '', TRUE);		
		$this->load->model('modelo_valores', '', TRUE);		
		$this->load->model('modelo_usuario', '', TRUE);		
		$this->load->model('modelo_materia', '', TRUE);	
    }

    function Index() {
	    $data['VistaPrincipal'] = 'vista_menu_administrador';
        $this->load->view('vista_maestra_admin', $data);
    }

    function NuevoEstudiante() {
		$this->form_validation->set_rules('Nombres', 'nombres', 'required|xss_clean');
        $this->form_validation->set_rules('Paterno', 'primer apellido', 'xss_clean');
		$this->form_validation->set_rules('Materno', 'segundo apellido', 'xss_clean');
		$this->form_validation->set_rules('Direccion', 'direcci&oacute;n', 'xss_clean');
       	$this->form_validation->set_rules('Correo', 'correo electr&oacute;nico', 'valid_email');
		$this->form_validation->set_rules('Identificacion', 'identificacion', 'required|xss_clean');		
        $this->form_validation->set_rules('CodCurso', 'curso', 'is_natural_no_zero');
		$this->form_validation->set_message('is_natural_no_zero', 'Debe seleccionar el curso del estudiante');
		$this->form_validation->set_error_delimiters('<div class="error">', '</div>');
		
        $data['VistaMenu'] = 'vista_menu_administrador';
        if ($this->form_validation->run()) {
		    $CodEstudiante = $this->modelo_estudiante->Insert($this->input->post('CodCurso'), $this->input->post('Nombres'),
                                            $this->input->post('Paterno'),$this->input->post('Materno'),
                                            $this->input->post('Direccion'),$this->input->post('Telefono'),
                                            $this->input->post('Correo'),$this->input->post('Identificacion'));
			$Nombre = $this->input->post('Nombres')." ".$this->input->post('Paterno')." ".$this->input->post('Materno');
			$Nick = ($this->input->post('Paterno')!=''?$this->input->post('Paterno'):$this->input->post('Materno'));
            $this->modelo_usuario->Insert($Nombre, $Nick, $this->input->post('Identificacion'), 'E', $CodEstudiante);
            $data['Mensaje'] = 'Se ha registrado un nuevo estudiante.';
            $data['VistaPrincipal'] = 'vista_mensaje';
        } else {
           	$data['ComboCurso'] = $this->modelo_curso->ComboCurso($this->input->post('CodCurso'));
            $data['VistaPrincipal'] = 'vista_nuevo_estudiante';
        }
		$this->load->view('vista_maestra_admin', $data);	
    }

    function BuscaParaModificarEstudiante($Modificacion) {
        $this->form_validation->set_rules('Nombre', 'nombre', 'xss_clean');
        $this->form_validation->set_rules('Paterno', 'paterno', 'xss_clean');
        $this->form_validation->set_rules('Materno', 'materno', 'xss_clean');
        $this->form_validation->set_rules('Identificacion', 'identificacion', 'xss_clean');
		$this->form_validation->set_error_delimiters('<div class="error">', '</div>');
		
        $data['VistaMenu'] = 'vista_menu_administrador';
        if ($this->form_validation->run()) {
            $registros = $this->modelo_estudiante->Busqueda($this->input->post('CodCurso'),
                                                $this->input->post('Paterno'), $this->input->post('Materno'),
                                                $this->input->post('Identificacion'));

            if( $Modificacion=='TRUE' )
                $Vista = 'vista_modifica_estudiante';
            else
                $Vista = 'vista_consulta_estudiante';
                
            if ($registros->num_rows() == 0) {
                $data['Mensaje'] = 'No se encontraron registros que cumplan el criterio de b&uacute;squeda';
                $data['VistaPrincipal'] = 'vista_mensaje';
				$this->load->view('vista_maestra_admin', $data);
            } else if ($registros->num_rows() == 1) {            //solo un registro encontrado
                $data['Fila'] = $registros->row();
                $data['ComboCurso'] = $this->modelo_curso->ComboCurso($data['Fila']->CodCurso);
                $data['VistaPrincipal'] = $Vista;                      //'vista_modifica_estudiante' o 'vista_consulta_estudiante';
                $this->load->view('vista_maestra_admin', $data);
            } else {                                             // varios registros encontrados: muestra lista
                $this->load->library('table');
                $this->table->set_empty("&nbsp;");
                $this->table->set_heading('No.', 'Nombre', 'Paterno ', 'Materno','Identificaci&oacute;n', 'Acci&oacute;n');
                $aux = array('table_open' => '<table class="tablaseleccion">');
                $this->table->set_template($aux);
                $i = 0;
                foreach ($registros->result() as $registro)
                    $this->table->add_row(++$i, $registro->Nombres,$registro->Paterno,$registro->Materno,$registro->Identificacion,
                            anchor("estudiante/CargaVista/$Vista/" . $registro->CodEstudiante, 
                            ($Modificacion=='TRUE'? ' Modificar ':' Ver '), 
                            array('class'=>($Modificacion=='TRUE'? 'actualiza':'vista'))). '  '.
                            anchor('estudiante/BorrarEstudiante/' . $registro->CodEstudiante, 'Eliminar', array('class'=>'elimina','onclick'=>"return confirm('Realmente desea borrar este registro?')")));
                $data['Tabla'] = $this->table->generate();
                $data['Vista'] = 'vista_busca_estudiante';
                $data['VistaPrincipal'] = 'vista_lista_estudiantes';
                $this->load->view('vista_maestra_admin', $data);
            }
        } else {
			$data['ComboCurso'] = $this->modelo_curso->ComboCurso(0);
            $data['VistaPrincipal'] = 'vista_busca_estudiante';
            $data['Modificacion'] = $Modificacion;            
			$this->load->view('vista_maestra_admin', $data);
        }
    }

    function ModificaEstudiante() {
		$this->form_validation->set_rules('Nombres', 'nombres', 'required|xss_clean');
        $this->form_validation->set_rules('Paterno', 'apellido paterno', 'xss_clean');
		$this->form_validation->set_rules('Materno', 'apellido materno', 'xss_clean');
		$this->form_validation->set_rules('Direccion', 'direcci&oacute;n', 'xss_clean');
       	$this->form_validation->set_rules('Correo', 'correo', 'valid_email');
		$this->form_validation->set_rules('Identificacion', 'identificacion', 'required|xss_clean');
		$this->form_validation->set_message('is_natural_no_zero', 'Debe seleccionar el curso del estudiante');
		$this->form_validation->set_error_delimiters('<div class="error">', '</div>');
		
        $data['VistaMenu'] = 'vista_menu_administrador';
        if ($this->form_validation->run()) {
            $Accion = $this->input->post("submit");
            if ($Accion == "Guardar cambios") {
                $this->modelo_estudiante->Update($this->input->post('CodEstudiante'), $this->input->post('CodCurso'), 
                                                $this->input->post('Nombres'), $this->input->post('Paterno'), 
                                                $this->input->post('Materno'), $this->input->post('Direccion'),
                                                $this->input->post('Telefono'),$this->input->post('Correo'),
                                                $this->input->post('Identificacion'));
				$Nombre = $this->input->post('Nombres')." ".$this->input->post('Paterno')." ".$this->input->post('Materno');
				$Nick = ($this->input->post('Paterno')!=''?$this->input->post('Paterno'):$this->input->post('Materno'));
                $this->modelo_usuario->Update($this->input->post('CodEstudiante'), 'E', $Nombre, $Nick);
				$data['Mensaje'] = 'Se han modificado los datos del estudiante.';
                $data['VistaPrincipal'] = 'vista_mensaje';
            }
            else {
                $this->modelo_estudiante->Delete($this->input->post('CodEstudiante'));
                $data['Mensaje'] = 'Los datos del estudiante han sido eliminados';
                $data['VistaPrincipal'] = 'vista_mensaje';
            }
        } else {
            $data['Fila'] = $this->modelo_estudiante->getFila($this->input->post('CodEstudiante'));
			$data['ComboCurso'] = $this->modelo_curso->ComboCurso($this->input->post('CodCurso'));
			$data['VistaPrincipal'] = 'vista_modifica_estudiante';
        }
		$this->load->view('vista_maestra_admin', $data);
    }

    function CargaVista($Vista, $CodEstudiante) {
        $data['VistaMenu'] = 'vista_menu_administrador';
        $data['Fila'] = $this->modelo_estudiante->getFila($CodEstudiante);
        $data['ComboCurso'] = $this->modelo_curso->ComboCurso($data['Fila']->CodCurso);
        $data['VistaPrincipal'] = $Vista;
        $this->load->view('vista_maestra_admin', $data);
    }

    function BorrarEstudiante($CodEstudiante) {
        $this->modelo_estudiante->Delete($CodEstudiante);
        redirect('estudiante','refresh');
    }
    
    function MenuEstudiantes() {
        $data['VistaMenu'] = 'vista_menu_administrador';
        $this->load->view('vista_maestra_admin', $data);
    }    
	
	function Boletin() {
		$data['VistaMenu'] = 'vista_menu_estudiante';
        $data['VistaPrincipal'] = 'vista_boletin';
		$data['TablaNotas'] = $this->modelo_estudiante->TablaNotas($this->session->userdata('CodEstudiante'));
		$this->load->view('vista_maestra_alumno', $data);
	}
	
	function BoletinPDF() {
		$this->load->library('fpdf');
		define('FPDF_FONTPATH',$this->config->item('fonts_path'));
		$CodEstudiante = $this->session->userdata('CodEstudiante');
		$data['CodEstudiante'] = $CodEstudiante;
		$data['Notas'] = $this->modelo_estudiante->getNotas($CodEstudiante);
		/*$data['Linea1'] =  $this->modelo_valores->GetTexto('LINEA1'); 
		$data['Linea2'] =  $this->modelo_valores->GetTexto('LINEA2');
		$data['Linea3'] =  $this->modelo_valores->GetTexto('LINEA3');*/
		$Fila = $this->modelo_estudiante->getFila($CodEstudiante);
		$data['NombreEstudiante'] = $Fila->Nombres." ".$Fila->Paterno." ".$Fila->Materno;
		$data['NombreCurso'] = $Fila->NombreCurso;
		$this->load->view('vista_boletin_pdf', $data);
	}
}

?>