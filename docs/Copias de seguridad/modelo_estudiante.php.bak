<?php

class Modelo_estudiante extends CI_Model {

    //nombre de la tabla
    private $Tabla = 'estudiante';

    function __construct() {
        parent::__construct();
    }

    function Insert($CodCurso, $Nombres, $Paterno, $Materno,$Direccion,$Telefono,$Correo,$Identificacion) {
        $sql = "INSERT INTO $this->Tabla (CodCurso, Nombres, Paterno, Materno,Direccion,Telefono,Correo,Identificacion) 
				VALUES ($CodCurso, '$Nombres', '$Paterno', '$Materno','$Direccion','$Telefono','$Correo','$Identificacion')";
        $this->db->query($sql);
		$sql = "SELECT LAST_INSERT_ID() AS Codigo";
		$row = $this->db->query($sql)->row();
		return $row->Codigo;
    }

    function Update($CodEstudiante, $CodCurso, $Nombres, $Paterno, $Materno,$Direccion,$Telefono,$Correo,$Identificacion) {
        $sql = "UPDATE $this->Tabla SET Nombres='$Nombres',
                Paterno='$Paterno',Materno='$Materno',Direccion='$Direccion', Telefono='$Telefono', Correo='$Correo', 
				Identificacion='$Identificacion', CodCurso=$CodCurso
				WHERE CodEstudiante=$CodEstudiante";
        return $this->db->query($sql);
    }

    function Busqueda($CodCurso, $Paterno, $Materno, $Identificacion) {
        $sql = "select estudiante.*, curso.Nombre as NombreCurso from $this->Tabla, curso
                where estudiante.CodCurso=curso.CodCurso
                and (Paterno='$Paterno' or '$Paterno'='') and
                (Materno='$Materno' or '$Materno'='') and
                (Identificacion='$Identificacion' or '$Identificacion'='') and
                (estudiante.CodCurso='$CodCurso' or '$CodCurso'='0')
                ORDER BY Paterno, Materno, Nombres";                
        return $this->db->query($sql);
    }

    function getFila($CodEstudiante) {
        $sql = "select estudiante.*, curso.Nombre as NombreCurso
                from $this->Tabla, curso 
                where estudiante.CodCurso=curso.CodCurso 
                and CodEstudiante=$CodEstudiante";
		return $this->db->query($sql)->row();
    }

    function Delete($CodEstudiante) {
        $this->db->where('CodEstudiante', $CodEstudiante);
        $this->db->delete($this->Tabla);
		$sql = "DELETE FROM usuario WHERE Codigo=$CodEstudiante AND Tipo='E'";
        $this->db->query($sql);
		$sql = "DELETE FROM notas WHERE CodEstudiante=$CodEstudiante";
        $this->db->query($sql);
		$sql = "DELETE FROM estudiante WHERE CodEstudiante=$CodEstudiante";
        $this->db->query($sql);
		$sql = "DELETE FROM habitos WHERE CodEstudiante=$CodEstudiante";
        $this->db->query($sql);		
		$sql = "DELETE FROM asistencia WHERE CodEstudiante=$CodEstudiante";
        $this->db->query($sql);
		$sql = "DELETE FROM registro_docente WHERE CodEstudiante=$CodEstudiante";
        $this->db->query($sql);
		$sql = "DELETE FROM historial WHERE CodEstudiante=$CodEstudiante";
        $this->db->query($sql);
    }
	
	function EstudianteExistente($Correo){
	    $sql = "select * from $this->Tabla where Correo='$Correo'";
        $query = $this->db->query($sql);	
		return $query->num_rows()>0;
	}
	
	function GetCodigo($CodUsuario) {
		$sql = "SELECT estudiante.CodEstudiante FROM estudiante, usuario
				WHERE estudiante.Correo=usuario.Nick
				AND usuario.CodUsuario=$CodUsuario";
        $query = $this->db->query($sql);	
		if($query->num_rows()>0) {
			$row = $query->row();
			return $row->CodEstudiante;
		}
		else
			return 0;
	}
	
	function GetCodEstudiante($CodUsuario) {
		$sql = "SELECT estudiante.CodEstudiante FROM estudiante, usuario
				WHERE (estudiante.Paterno=usuario.Nick OR estudiante.Materno=usuario.Nick)
				AND usuario.CodUsuario=$CodUsuario";
        $query = $this->db->query($sql);	
		if($query->num_rows()>0) {
			$row = $query->row();
			return $row->CodEstudiante;
		}
		else
			return 0;
	}
	
	function GetCodCurso($CodEstudiante) {
		$sql = "SELECT CodCurso FROM estudiante
				WHERE CodEstudiante=$CodEstudiante";
        $query = $this->db->query($sql);	
		if($query->num_rows()>0) {
			$row = $query->row();
			return $row->CodCurso;
		}
		else
			return 0;
	}

	function CalculaPromedios($CodEstudiante, $CodMateria, $Trimestre) {
		$sql = "SELECT CodMateria, AVG(Nota) AS Promedio FROM Notas
				WHERE CodEstudiante=$CodEstudiante 
				AND CodMateria=$CodMateria 
				AND Trimestre=$Trimestre";
		return $this->db->query($sql);
	}
	
	function TablaMateriasCurso($CodEstudiante, $Periodo) {
        $sql = "SELECT materia.CodMateria AS CodMateria2, materia.Nombre, registro_docente.*
				FROM curso, materia LEFT OUTER JOIN registro_docente
				ON materia.CodMateria=registro_docente.CodMateria
				AND registro_docente.CodEstudiante=$CodEstudiante
				AND registro_docente.Periodo=$Periodo
				WHERE curso.CodCurso=materia.CodCurso
				ORDER BY materia.Orden ";
        return $this->db->query($sql);	
    }
	
	function NombreMateria($CodMateria) {
		$sql = "select Nombre from materia WHERE CodMateria=$CodMateria";
        $query = $this->db->query($sql);
		if( $query->num_rows()>0 ) {
			$row = $query->row();
			return $row->Nombre;
		}
		else
			return '';
	}
	
	function TablaNotas($CodEstudiante) {
		$row = $this->getFila($CodEstudiante);
		$CodCurso = $row->CodCurso;
		
		$query = $this->TablaMateriasCurso($CodEstudiante, 1);  //primer semestre
		//para cada materia, obtenemos su promedio de 1r.sem
		$Cods = array(); 
		$S1 = array(); $S2 = array();
		foreach($query->result() as $row) {
			$r = 0; $c = 0;
			for($i=1; $i<=12; $i++) {
				eval('$aux = $row->n'.$i.';');
				$r += $aux; 
				$c += ($aux!=0? 1: 0);
			}
			$Cods[$row->CodMateria2] = $row->CodMateria2;
			$S1[$row->CodMateria2] = ($c!=0? $r/$c: 0);
			$S2[$row->CodMateria2] = 0;
		}
		
		$query = $this->TablaMateriasCurso($CodEstudiante, 2);  //segundo semestre
		//para cada materia, obtenemos su promedio de 2o.sem
		foreach($query->result() as $row) {
			$r = 0; $c = 0;
			for($i=1; $i<=12; $i++) {
				eval('$aux = $row->n'.$i.';');
				$r += $aux; 
				$c += ($aux!=0? 1: 0);
			}
			$S2[$row->CodMateria2] = ($c!=0? $r/$c: 0);
		}

		if(isset($S1) || isset($S2)) {
			$s = '<table class="tablaformulario"><tr><th>Asignatura</th><th>1r.semestre</th><th>2o.semestre</th><th>Prom.anual</th></tr>';
			foreach($Cods as $c) {
				$s .= '<tr>';
				$s .= '<td>'.$this->NombreMateria($c).'</td>';
				$s .= '<td style="text-align:center">'.sprintf('%.1f', $S1[$c]).'</td>';
				$s .= '<td style="text-align:center">'.sprintf('%.1f', $S2[$c]).'</td>';
				$s .= '<td style="text-align:center">'.sprintf('%.1f', promedio2($S1[$c],$S2[$c])).'</td>';
				$s .= '</tr>';
			}
			$s .= '</table>';
			return $s;
		}
			return '';
	}

	function Observaciones($CodEstudiante, $Trimestre) {
		$sql = "SELECT Obs FROM habitos WHERE CodEstudiante=$CodEstudiante AND Trimestre=$Trimestre";
		$query = $this->db->query($sql);
		$s = "<table class='tablaformulario'><tr><th>Observaciones</th></tr>";
		if( $query->num_rows()>0) {
			$row = $query->row();
			return $s."<tr><td>".$row->Obs."</td></tr></table>";
		} else
			return '';
	}
	
    function getObservaciones($CodEstudiante, $Trimestre) {
		$sql = "SELECT Obs FROM habitos WHERE CodEstudiante=$CodEstudiante AND Trimestre=$Trimestre";
		$query = $this->db->query($sql);		
		if( $query->num_rows()>0) {
			$row = $query->row();
			return $row->Obs ;
		} else
			return '';
	}	
	
	function getNotas($CodEstudiante) {
		$row = $this->getFila($CodEstudiante);
		$CodCurso = $row->CodCurso;
		$query = $this->modelo_materia->TablaMaterias($CodCurso);
		//para cada materia, obtenemos su promedio
		$Notas = array();
		$Materias = array();
		foreach($query->result() as $row) {			
			$Notas[$row->CodMateria] = array('CodMateria'=>$row->CodMateria, 'Nombre'=>$row->Nombre, 'T1'=>0, 'T2'=>0, 'T3'=>0);
			for($i=1; $i<=3; $i++) {
				$promedios = $this->CalculaPromedios($CodEstudiante, $row->CodMateria, $i);
				
				foreach($promedios->result() as $promedio) {
					if(! is_null($promedio->CodMateria))
						$Notas[$promedio->CodMateria]["T$i"] = $promedio->Promedio;
				}
			}	
		}
		return $Notas;
	}
}