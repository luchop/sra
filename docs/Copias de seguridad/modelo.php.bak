<?php

class Modelo extends CI_Controller {

	private $PuedeModificar;
	private $TipoUsuario;
	
    function __construct() {
        parent::__construct();
        $this->load->model('modelo_articulo', '', TRUE);
		$this->form_validation->set_error_delimiters('<div class="error">', '</div>');
		$this->modelo_articulo->SetCodInstitucion($this->session->userdata('CodInstitucion'));
		$this->modelo_articulo->SetTabla('modelo');
		$this->TipoUsuario = $this->session->userdata('TipoUsuario');
		if( $this->TipoUsuario==1 ) 
			$this->PuedeModificar = 1;
		else if( $this->TipoUsuario==2 ) 
			$this->PuedeModificar = 1;
		else if( $this->TipoUsuario==3 ) 
			$this->PuedeModificar = 0;		
    }

    function Index() {
        $this->ListaModelos();
    }
	
    function NuevoModelo() {
        $this->form_validation->set_rules('Nombre', '"nombre"', 'required|min_length[3]|xss_clean|callback_NombreUnico');
        if ($this->form_validation->run()) {
            $this->modelo_articulo->Insert($this->input->post('Nombre'));
        }
		//redirect('modelo/ListaModelos','refresh');
		$this->ListaModelos();
    }

    function ListaModelos() {
        $registros = $this->modelo_articulo->Busqueda();
		$this->load->library('table');
        $this->table->set_empty("&nbsp;");
		if( $this->PuedeModificar==1 )
			$this->table->set_heading('No.', 'Nombre del modelo', 'Acci&oacute;n');
		else
			$this->table->set_heading('No.', 'Nombre del modelo');
        $aux = array('table_open' => '<table class="tablaseleccion">');
        $this->table->set_template($aux);
        $i = 0;
        foreach ($registros->result() as $registro)
			if( $this->PuedeModificar==1 )
                $this->table->add_row(++$i, form_open('modelo/ModificaModelo',array('id'=>'form_'.$registro->CodModelo)).form_input('Nombre',$registro->Nombre).form_hidden('CodModelo',$registro->CodModelo).'</form>', 
                        '<a href="javascript:void(0)" class="actualiza" onclick="$(\'#form_'.$registro->CodModelo.'\').submit()">Modificar</a> '.
                        anchor('modelo/BorrarModelo/' . $registro->CodModelo, 'Eliminar', array('class'=>'elimina','onclick'=>"return confirm('Realmente desea borrar este registro?')")));
			else
				$this->table->add_row(++$i, $registro->Nombre);

        if( $this->TipoUsuario==1 ) 
			$data['VistaMenu'] = 'vista_menu_admin';
		else if( $this->TipoUsuario==2 ) 
			$data['VistaMenu'] = 'vista_menu_operador1';
		else if( $this->TipoUsuario==3 ) 
			$data['VistaMenu'] = 'vista_menu_operador2';
		$data['Tabla'] = $this->table->generate();
        $data['Vista'] = 'vista_busca_articulo';
        $data['VistaPrincipal'] = 'vista_lista_modelos';
        $this->load->view('vista_maestra', $data);
    }

    function ModificaModelo() {
        $this->form_validation->set_rules('Nombre', '"nombre"', 'required|min_length[3]|xss_clean');
        if ($this->form_validation->run()) {
				$this->modelo_articulo->Update($this->input->post('CodModelo'),$this->input->post('Nombre'));
                $data['Mensaje'] = 'Se han modificado los datos del modelo.';
        }
		redirect('modelo/ListaModelos','refresh');
    }

    function BorrarModelo($CodModelo) {
        $this->modelo_articulo->Delete($CodModelo);
        redirect('modelo/ListaModelos','refresh');
    }

	function NombreUnico($Nombre){
		if ($this->modelo_articulo->ExisteNombre($Nombre)){
			$this->form_validation->set_message('NombreUnico', 'Este nombre ya fue registrado.');
			return FALSE;
		}else{
			return TRUE;
		}
	}
}

?>